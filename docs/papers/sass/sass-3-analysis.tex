\newcommand{\nweak}{\ensuremath{w}}
\newcommand{\weakperiod}{\ensuremath{\mathsf{\Gamma_\nweak}}}
\newcommand{\thweak}{\ensuremath{\tau_w}}
\newcommand{\numleak}{\ensuremath{\mathsf{leak}}}
\newcommand{\numanom}{\ensuremath{\mathtt{num\_anon}}}
\newcommand{\allvrfs}{\ensuremath{\mathtt{all\_vrfs}}}
\newcommand{\ub}{\ensuremath{\mathsf{ub}}}
\newcommand{\lb}{\ensuremath{\mathsf{lb}}}
\newcommand{\lbsumL}{\ensuremath{\underline{ \vrfwinninglist}^{\mathsf{sum}}}}
\newcommand{\ubL}{\ensuremath{\bar{\vrfwinninglist}}}
\newcommand{\eplen }{\ensuremath{R}}
\newcommand{\A }{\ensuremath{\mathcal{A}}}
\newcommand{\publicslots}{\ensuremath{\mathtt{public\_slots}}}
\newcommand{\phonestslots}{\ensuremath{\mathtt{p\_honest\_slots}}}
\newcommand{\honestslots}{\ensuremath{\mathtt{honest\_slots}}}
\newcommand{\malslots}{\ensuremath{\mathtt{mal\_slots}}}
\newcommand{\randweakslot}{\ensuremath{r\_weak\_slots}}
\newcommand{\publicvrfs}{\ensuremath{\mathtt{public\_vrfs}}}
\newcommand{\phonestvrfs}{\ensuremath{\mathtt{p\_honest\_vrfs}}}
\newcommand{\honestvrfs}{\ensuremath{\mathtt{honest\_vrfs}}}
\newcommand{\malvrfs}{\ensuremath{\mathtt{mal\_vrfs}}}
\newcommand{\malslotset}{\ensuremath{\mathcal{S}_m}}
\newcommand{\weakslotset}{\ensuremath{\mathcal{S}_w}}
\newcommand{\honestslotset}{\ensuremath{\mathcal{S}_h}}
\newcommand{\subslots}{\ensuremath{\mathbb{S}}}
\newcommand{\negl}{\ensuremath{\mathsf{negl}}}

\section{Analysis}

\subsection{Security Definitions}

\begin{definition}[Chain Growth (CG) Property \cite{backbone}] \label{def:cg}
	The CG  property with parameters $ s, s_{cg}\in \mathbb{N} $ ensures that if the length of a blockchain owned by an honest party at the onset of a round $ C_u $ is $ \ell_u $ and the length of the same blockchain at round $ C_v  $ where $ C_v \leq C_u - s  $ is $\ell_v$, then the $ s \geq \ell_u  - \ell_v \geq  s_{cg} $.
	
	
\end{definition}

In other words, the CG property guarantees if a chain is owned by an honest party at a round, then this chain has grown $ s_{cg}$ blocks in every $ s_{cg} $ rounds. 

\begin{definition}[Chain Quality (CQ) Property \cite{backbone}]\label{def:cq}
	The CQ property with parameters $ \mu \in (0,1]  $ and $ k \in \mathbb{N} $ ensures that the ratio of honest blocks in any $ k $ length portion of a blockchain owned by an honest party is at least $ \mu $.
\end{definition} 

The CQ property ensures the existence of sufficient honest blocks on  any blockchain owned by an honest party.

We prove the chain growth of the best chain assuming that the weakly corrupted validators do not produce the block. We assume that the adversary can weakly corrupt validators whose chance to produce the next block is less than $ \thweak' $.
\paragraph{Adversarial Model:} In our model, we assume that there exists $ n $ validators.  We consider two type of corruption in our model. We call the first corruption model \emph{strong corruption} and the second one \emph{weak corruption}. When a validator is strongly corrupted, it means that the current state (non-volatile memory) of the validator is shared with the adversary. We assume that every validator starts a new era with a freshly generated keys and erases the old keys. The adversary can strongly corrupt up to $ f = (1-\alpha)n $ validators in one era where $ \alpha \in (0,1] $ is the ratio of honest validators.  
When a validator is weakly corrupted, it means that the validator is not able to participate the protocol. The weak corruption basically silence the validator as if she does not exists. The adversary can weakly corrupt up to $ \nweak $ validators at the same time at most  $ \weakperiod $ slots. A weakly corrupted validator is considered as malicious if she does not contribute the protocol as she is supposed to do because of the weakly corruption.  In other words, if the view of the protocol at the time that the validator is weakly corrupted is different than the view of the protocol without the corruption, then we assume this validator malicious and consider it as successful weakly corruption.  We denote honest validators set in one sortition and one block production phase by $ \mathcal{H} $ where $ |\mathcal{H}| = n_H = n-f - f_\nweak$ where $ f_\nweak $ is the number of malicious validators because of the weakly corruption.  Therefore, in our analysis below, we consider the security of Sassafras with $ f + f_{\nweak}$ malicious validators out of $ n $ validators. 

We analyze the number $ f_{\nweak} $ considering that the adversary can corrupt at most $ w $ validators at the same time. For this, We analyze the best strategy for an adversary to maximize $ f_{\nweak} $ in Sassafras.


%Remark that the adversary needs to weakly corrupt constantly a validator to make this validator malicious because in this case the validator will not have any chance to submit her VRF values. 

This separation lets us analyze the security of Sassafras with more appropriate assumptions. Remark that a strongly corrupted validator behaves arbitrarily according to the adversarial will while weakly corrupted validator just stops running on time within $ \weakperiod $ slots. For example, the adversary can never make a weakly corrupted validator to construct on top of non-best chain. Therefore, weakly corrupted validators do not help  the adversary to construct a chain to break common prefix property or existential chain quality.  However, they help the adversary without consent to reduce the chain growth because they stop producing blocks or they produce blocks much later than expected.




%TODO No successfull weak corruption before starting an epoch 
%	\item This game is played against an adversary which breaks the security of  Sassafras with probability $ p_1 $. The sub phases that is executed to decide block producers of epoch $ e $ takes $ l $ epochs.	
%In these $ l $ epochs, the period that a validator generates and sends VRFs to repeater takes $ \Gamma_{\mathsf{vrf}} $ slots, that a repeater publishes all VRFs takes $ \Gamma_{\mathsf{rep}} $ slots and that the validator publishes her unpublished VRFs takes $ \Gamma_{\mathsf{last}} $ slots. 
%
%%One epoch consists of $ \eplen  $ slots.
%
%
%The number of VRF outputs that are published to be sorted are $ \allvrfs $. Remember that all VRF outputs that are published are less than the threshold $ c $. $ \phonestvrfs $ of them are given to the adversary to be published (i.e., if the repeater is the malicious, then the owner of the VRF is leaked to the adversary). In other words, the adversary knows the owner of $ \phonestvrfs $ many honest validators' VRF outputs
%
%One epoch consists of $ \eplen  $ slots. $ \publicslots $ are the number of slots whose block producer is known by the adversary. $ \phonestslots $ of them are the number of slots whose block producer is honest and known by the adversary. So, $ \eplen  - \publicslots $ of them is not known by the adversary before starting the epoch.
%
%$ \malslotset $ is a slot set that includes the assigned to a malicious validator. $ \weakslotset $ is a slot set that includes the slots which are assigned to weakly corrupted validators during their slot. $ \honestslotset $ is the set of the rest of the slots (honest slots) which is not in $ \malslotset $ or $ \weakslotset $. 
%
%In the next games, we bound these parameters.
%
%\item We reduce the previous game to the game where the adversary cannot corrupt  any honest validator weakly and successfully during the sub phases. This game is indistinguishable from the previous game  because $ \Gamma_{\mathsf{vrf}}, \Gamma_{\mathsf{rep}}, \Gamma_{\mathsf{last}}> \weakperiod $. In other words, the weak corruptions in the previous game during sub phases will never be successful because after a validator is weakly corrupted during $\weakperiod $ slots, she will still have time to complete the sub-phase. So the view of the protocol does not change\footnote{We can also consider the adversary where $ \weakperiod > \Gamma_{\mathsf{vrf}}, \Gamma_{\mathsf{rep}}, \Gamma_{\mathsf{last}} $ but it requires more complicated analysis. So, it is left as a future work.} in all sub phases. In other words, all VRF outputs generated by honest validators and less than $ c $ are published in the blockchain. So, $ p_1 = p_2 $.



%\paragraph{Honest Slot:} We call a slot associated with a VRF value $ \omega_{V,e,i} $ is an honest slot  if $ V $ is an honest validator and $ \mathcal{V}[H(\omega_{V,e,i}||``WHO'')] $ is not a corrupted validator. Therefore, the probability of having an honest slot is $ p_{\mathsf{hslot}} = \alpha^2 $.  


\paragraph{Public Slot:} We call a slot associated with a VRF value $ \omega_{V,e,i} $ is a weak slot  if $ V $ is an honest validator and $ \mathcal{V}[H(\omega_{V,e,i}||``WHO'')] $ is not a corrupted validator. Therefore, the probability of having a weak slot is $ p_{\mathsf{pSlot}} = \alpha (1-\alpha) $.  

\paragraph{Malicious Slot:}  We call a slot associated with a VRF value $ \omega_{V,e,i} $ is a malicious slot  if $ V $ is a strongly corrupted validator. Therefore, the probability of having a malicious slot is $ p_{\mathsf{mSlot}} =  (1-\alpha) $.  



\paragraph{Rand-Weak Slot:} We call a slot associated with a VRF value $ \omega_{V,e,i} $ is a random weak slot  if $ V $ is an honest validator and $ \mathcal{V}[H(\omega_{V,e,i}||``WHO'')] $ is not a corrupted validator and the adversary weakly corrupts $ V $ in the slot with the VRF value $ \omega_{V,e,i} $.  Below, we find the probability of having rand-weak slot $ p_{rSlot} $.

\begin{lemma}
	The probability that a slot is a rand-weak is less than $$(1 - \exp(-\frac{\mu_{\mathsf{hvrf}}\delta_{\mathsf{hvrf}}}{2}))\frac{w \vrfaattemptsbound }{\mu_{\mathsf{hvrf}} (1- \delta_{\mathsf{hvrf}}) - (\eplen  -1)} $$ where $ 0 < \delta_{\mathsf{hvrf}} < 1 $, $ \mu_{\mathsf{hvrf}} = (n-f)c\alpha\vrfaattemptsbound $ and  $ \eplen  $ is the epoch length.
\end{lemma}

\begin{proof}
	Consider a slot $ sl $ in an epoch $ e $ with the VRF input $ (r_e||i) $. Since $ (r_e||i) $ of the VRF output of $ sl $ is public, the adversary can eliminate validators for this slot $ sl $ to weakly corrupt who have already produced a block on a slot with the VRF input-index $ i $ and public validators who will produce with VRF input-index $ i $ in next slots. Let's call such validators \emph{inactive} for slot $ sl $ and assume that their number is $ n_i $. After eliminating the inactive validators, the adversary can compute the probability that an active  and honest validator $ V $ is selected in slot $ sl $ based on the number of blocks that she produced so far $ (\ell_V) $ and. So, this probability is
	
	%$$p_{V,s} = \frac{|\vrfwinninglist_V|- \ell_V}{\sum_{V' \in \mathcal{H}_a}|\vrfwinninglist_{V'}| -\ell_{V'}-\numleak} \leq \frac{\vrfaattemptsbound - \ell_V}{\numanom - (s-1)}$$
	
	\begin{equation}\label{eq:prVs}
	p_{V,sl} = \frac{|\vrfwinninglist_V|- \ell_V}{\honestvrfs - \sum_{V' \in \mathcal{H}_a}\ell_{V'}}\leq \frac{\vrfaattemptsbound - \ell_V}{\honestvrfs - (R-1)}
	\end{equation}
	
	
	where $ \honestvrfs $ is the number of honest validators' VRF outputs which are anonymous to the adversary.
	In this case the best strategy for the adversary to increase her chance to  weakly corrupt the right validator  is sorting the list $ \{p_{V,sl}\}_{V \in \mathsf{Active}} $ in ascending order, and weakly corrupting the first $ w $ of the validators in the sorted $ \{p_{V,sl}\}_{V \in \mathsf{Active}} $. Therefore, the probability that being a rand-weak slot is less than $  \frac{w\vrfaattemptsbound }{\honestvrfs - (R-1)}  $.
	
	Now let's lower bound $ \honestvrfs $ to upper bound $ p_{\mathsf{rweak}} $.	For this, we define a random variable $ R_{V,e,i} $ which is 1 if $ V $ is an honest validator, $ U = \vals[H(\omega'_{V,e,i} \| "WHO") \mod |\vals|]  $ corresponds to  \emph{an honest validator}, $ \omega'_{V,e,i} < c $. Otherwise, it is 0.  In this case, $ \pr[R_{V,e,i} = 1] = \alpha c$ and
	the expected number of $ R_{V,e,i}  = 1$ is  $ \mu_{\mathsf{hvrf}} = (n-f) \vrfaattemptsbound \alpha c $. We can bound the probability of having $ \honestvrfs $ close to the expected value with  the Chernoff bound as follows for all $ 0 <\delta_{\mathsf{hvrf}} < 1 	 $:
	
	\begin{equation}\label{eq:beforeepcoh}
	\epsilon_4 = \pr[ \honestvrfs = \sum_{\substack{ \forall V \in \mathcal{H} \\0\leq i < \vrfaattemptsbound}} R_{V,e,i} \leq \mu_{\mathsf{hvrf}} (1 - \delta_{\mathsf{hvrf}})] < \exp(-\frac{\mu_{\mathsf{hvrf}}\delta_{\mathsf{hvrf}}^2}{2}) \nonumber
	\end{equation}
	
	Hence, we can upper bound the probability of having a rand-weak slot with
	$$(1 - \exp(-\frac{\mu_{\mathsf{hvrf}}\delta_{\mathsf{hvrf}}}{2}))\frac{w \vrfaattemptsbound }{\mu_{\mathsf{hvrf}} (1- \delta_{\mathsf{hvrf}}) - (\eplen  -1)} $$
\end{proof}

\paragraph{Honest Slot:} We call a slot associated with a VRF value $ \omega_{V,e,i} $ is an honest slot  if it is not neither a malicious slot, nor public slot or rand-weak slot. Therefore, the probability of having an honest slot is $ p_{\mathsf{hSlot}} = 1- p_{\mathsf{mSlot}} - p_{\mathsf{pSlot}} - p_{\mathsf{rSlot}}  $.  


\begin{lemma}[ECQ]
	If $ p_{\mathsf{mSlot}} < p_{\mathsf{hSlot}} $, the adversary breaks the existential chain quality with the parameter $ \malslots $ except with probability $ 1- \exp(-\Omega(k)) $.
\end{lemma}

\begin{proof}
	
	Let's consider consecutive $ k_{ecq} $ blocks $ B_1, B_2, ..., B_{k_{ecq}} $ of a chain $ \mathbf{B} $ owned by an honest validator  and assume that all of them generated by a malicious validator. Imagine that the first honest block before $ B_1 $ is $ B_{h_1}  \in \mathbf{B}$  and the first honest block after $ B_{k_{ecq}} $ is $ B_{h_2}  \in \mathbf{B}$. Remark that $ B_{h_1} $ exists because it is the genesis block in the worst case. Also, $ B_{h_2} $ exists because it is owned by an honest validators so in the worst case it is the last block of $ \mathbf{B} $. We know that the difference between the length of the chain whose last block is generated by the honest validator and the length of the chain whose last block is generated by the next honest validator is at least one because honest validators always build on top of the longest chain. Therefore, the length of the other chains that the honest validators build will be at least the number of honest slots $ (h) $ between the slot of $ B_{h_1} $ and $ B_{h_2} $. Since $ \mathbf{B} $ is the honest validator's best chain, it is longer than other chains meaning that $ k_{ecq} \geq h $.  Since $ p_{\mathsf{mSlot}} < p_{\mathsf{hSlot}} $ the probability that there are less than $ k_{ecq} $ honest slots given that there are $ k_{ecq} $ malicious slots is  falls exponantially with $ k_{ecq} $.
\end{proof}


\begin{lemma}[CP]
	Assuming that probability that having  $ p_{\mathsf{hSlot}} >\frac{1}{2}$, Sassafras satisfies the common prefix property  with the parameter $ k $ except with the probability  $ \exp(-\Theta(k)) $. 
\end{lemma}

Thanks to the result of  Kiayias et al. \cite{consistency}, that if probability that having an honest slot is greater than the probability of having malicious slot and weak slot, chain prefix property is guaranteed with the error bound $ \exp(-\Theta(k)) $.

If a weakly corrupted validator informs everyone after the corruptions, then the chain that includes his block could be ignored by other validators. Thus, weakly corrupted validators do not help the adversary to break the common prefix property. If we had such mechanism in Sassafras, then having $ p_{\mathsf{hSlot}}  > p_{\mathsf{mSlot}} $ would be enough to achieve CP. 


\begin{lemma}[HCG]
	Sassafras satisfies the honest chain growth property with $ \tau_{hcg} = p_{\mathsf{hSlot}}(1-\delta_{\mathsf{hSlot}}  $ in $ s_{hcg} $ slots except with the probability $ \exp(-\frac{sp_{\mathsf{hSlot}}\delta_{\mathsf{hSlot}}^2}{2}) $ where $ 0< \delta_{\mathsf{hSlot}} < 1 $.
\end{lemma}

\begin{proof}
	Consider a chain $ \mathbf{B} $ owned by an honest validator at slot $ sl $. Let $ sl_u $ and $ sl_v $ be two previous slots where $ \mathbf{B}[sl_u] $ and $ \mathbf{B}[sl_v] $ are generated by honest validators and $ sl_u + s \leq sl_v $. As discussed in  Lemma \ref{lem:ecq}, the chain grows between $ \mathbf{B}[sl_u] $ and $ \mathbf{B}[sl_v] $ at least the number of honest slots. Therefore, let's upper bound the honest slots with the Chernoff bound for all $ 0<\delta_{\mathsf{hSlot}}<1 $.
	
	\begin{equation}
	\pr[\honestslots = \sum_{sl_u}^{sl_v}S_i \leq s p_{\mathsf{hSlot}}(1-\delta_{\mathsf{hSlot}})] < \exp(-\frac{sp_{\mathsf{hSlot}}\delta_{\mathsf{hSlot}}^2}{2})
	\end{equation}
	
	
\end{proof}


\begin{lemma}[CG]
	Assuming that ECQ property is satisfied in $ s_{ecq} $ slots and the number of honest slots in $ s $ slots is at least $ \honestslots $, then the chain grows at least $ \honestslots $ in $ 2s_{ecq} + s_{hcg} $ slots.
\end{lemma}

\begin{proof}
	Consider the subchain $ B[sl_i,sl_i+s_{ecq}] $ spanned between slots $ sl_i $ and $ sl_i + s_{ecq} $  which is the subchain of a best chain in slot $ sl_i +  2s_{ecq} + s  $. Thanks to the ECQ property $ B[sl_i,sl_i+s_{ecq}] $ contains at least one block $ B_1 $ generated in an honest slot.   Now consider another subchain $ B[sl_j -s_{ecq} :sl_j] $ of the best chain spanned between slots $ sl_j - s $ and $ sl_j $ where $ sl_j $  is the last slot of $ e $. Similarly, $ B[sl_j -s_{ecq} :sl_j] $ contains at least one block $ B_2 $ generated on an honest slot. Lastly, we consider another subchain between blocks $ B_1 $ and $ B_2 $.  Thanks to honest chain growth, the length of the the subchain between $ B_1 $ and $ B_2 $ is at least equal to the number of honest slots between them which is $ \honestslots $. 
\end{proof}
%\paragraph{Expected Number of VRFs:}
%The expected number of VRFs by honest validators and by strongly corrupted validators play a key role to analyze the distribution of honest and malicious slots. Probability that the repeater of a VRF value $ \omega_{V,e,i} < c $ is a corrupted validator is $ (1-\alpha) $. 

%We call a slot associated with a VRF value $ \omega_{V,e,i} $ is honest slot  if $ V $ is an honest validator and $ \mathcal{V}[H(\omega_{V,e,i}||``WHO'')] $ is not a corrupted validator. Therefore, the probability that a slot is honest slot is $ p_{\mathsf{hslot}}\alpha^2 $.  If $ V $ is an honest validator but $ \mathcal{V}[H(\omega_{V,e,i}||``WHO'')] $ is a corrupted validator, then we call this slot 
%
%
%$ p_{hslot} = \alpha^2, p_{mslot} = \alpha, p_{phslot} = (1-\alpha)\alpha $
%
% Therefore, the expected number of VRF values whose owner is public to the adversary is
%
%$$\mu_{\mathsf{phvrf}} = (1-\alpha) \alpha c * \vrfaattemptsbound $$
%
%Similarly, the expected number of VRF values whose owner is not known by the adversary is
%
%$$\mu_{\mathsf{hvrf}} =  \alpha^2 c * \vrfaattemptsbound $$
%
%The expected number of malicious VRFs are
%
%$$\mu_{mvrf} = \alpha c * \vrfaattemptsbound $$








%TODO more formal reduction and Lemma X. 
%TODO proof of Pr[one validator selected] = 1/n after VRF pseuodrandomness def.
