\newcommand{\nweak}{\ensuremath{w}}
\newcommand{\strongperiod}{\ensuremath{\mathsf{\Gamma_S}}}
\newcommand{\thweak}{\ensuremath{\tau_w}}
\newcommand{\numleak}{\ensuremath{\mathsf{leak}}}
\newcommand{\numanom}{\ensuremath{\mathfrak{A}}}
\section{Analysis}

\paragraph{Adversarial Model:} In our model, we assume that there exists $ n $ validators.  We consider two type of corruption in our model. We call the first corruption model \emph{strong corruption} and the second one \emph{weak corruption}. When a validator is strongly corrupted, it means that the current state (non-volatile memory) of the validator is shared with the adversary . We assume that the adversary can strongly corrupt up to $ f $ validators in a certain period $\strongperiod$.  We denote honest validators set by $ \mathcal{H} $ where $ |\mathcal{H}| = n_H = n-f $. 
When a validator is weakly corrupted, it means that the validator is not able to participate the protocol. The weak corruption basically silence the validator as if it does not exists. The adversary can weakly corrupt up to $ \nweak $ validators at the same time. 


\paragraph{Leakage of the Block Producer's Identity:}

TODO: VRF anonymity reduction

We know that when a validator gives the VRF output to a repeater, its anonymity is compromised by the repeater. If the repeater is a corrupted node, then it means that the block producer's identity is leaked to the adversary. We first discuss what the expected number of these unfortunate nodes is. 

%Expected $ \Psi = c * n * \vrfaattemptsbound  $. $ \Psi $ should be big enough so that it is greater than $ R $ with a big probability and $ \Psi $ should be small enough so that $ \Psi / R $ not big.

We define a random variable $ R_{V,e,i} $ which is 0 if $ U = \vals[H(\omega'_{V,e,i} \| "WHO") \mod |\vals|]  $ corresponds to a corrupted node and $ \omega'_{V,e,i} < c $. Otherwise, it is 1. For simplicity of our analysis, we do not consider $ \vrfarepeatbound $. In this case, $ \pr[R_{V,e,i} = 0] = \frac{fc}{n} $ and
the expected number of $ R_{V,e,i}  = 0$ is  $ \Psi \frac{fc}{n} $ where $ \Psi = (n-f) \vrfaattemptsbound $ (the number of VRF outputs generated by honest validators). We can bound the probability of having the leakage more than some value with the Chernoff bound as follows for all $ \delta > 0 	 $:

\begin{equation}\label{eq:beforeepcoh}
\pr[\numleak = \sum_{\substack{ \forall V \in \mathcal{H} \\0\leq i < \vrfaattemptsbound}} R_{V,e,i} \geq \Psi \frac{fc}{n} (1+ \delta)] < \exp(-\frac{\Psi f c\delta^2}{n(2+\delta)}) \nonumber
\end{equation}


This probability helps us to find the upper bound of VRF values whose anonymity is compromised by the adversary before starting an epoch i.e., $ \numleak < \Psi \frac{fc}{n} (1+ \delta) $ with probability $ 1- \exp(-\frac{\Psi f c\delta^2}{n(2+\delta)}) $. In this case the total number of anonymous VRF values is $  \numanom < \sum_{k \in \mathcal{H}} |\vrfwinninglist_{V_k}| -  \Psi \frac{fc}{n} (1+ \delta)$.

Now, we need to find the leaked information related to block producers' identity during an epoch. 
Since input $ (r_e||i) $ of the winner VRF value of a slot $ L $ is already known, the adversary can eliminate validators for this slot $ L $ who have already produced a block on a slot with the VRF input-index $ i $ and leaked validators who will produce with VRF input-index $ i $ in next slots. Let's call such validators \emph{inactive} for slot $ L $ and assume that their number is $ n_i $. Considering this the probability of a validator $ V $ being a block producer in slot $ L $ with VRF input-index $ i $ of an epoch $ e $ ($ p_{V,e, L, i} $)  is as follows:

\begin{equation*}
p_{V,e, L, i} \leq \begin{cases}
0 &\text{if } V \text{ is inactive in slot } L\\
\max(\frac{1}{n_H - n_i},\frac{|\vrfwinninglist_V|- \ell_V}{\numanom|-(L-1)})&\text{otherwise}
\end{cases}
\end{equation*}

where  $ \ell_V $ is the number of slots that $ V $ was the slot leader so far in $ e $. We want to make sure that $ p_{V,e,L,i} < \thweak$. Here, $ \thweak $ is a threshold for the adversary. If $ p_{V,e,L} \geq \thweak $, the adversary weakly corrupts validators . We do the analysis of having $ p_{V,e,L} \geq \thweak $ for $ c =1 $ and when $ 0 < c < 1 $:

\begin{itemize}
	\item $ c = 1: $ When $ c =1 $, $ \frac{|\vrfwinninglist_V|- \ell_V}{\numanom-(L-1)} = \frac{\vrfaattemptsbound - \ell_V}{n_H*\vrfaattemptsbound -  \Psi \frac{f}{n} (1+ \delta)- (L-1)} $.
	\begin{align}\label{cond:eq1}
	\frac{\vrfaattemptsbound - \ell_V}{n_H*\vrfaattemptsbound(1-\frac{f(1+\delta)}{n}) - (L-1)} < \thweak &\implies \frac{(L-1)\thweak - \ell_V}{n_H\thweak(1-\frac{f(1+\delta)}{n})-1} < \vrfaattemptsbound \nonumber \\
	&\implies \max(\frac{(L-1)\thweak - \ell_V}{n_H\thweak(1-\frac{f(1+\delta)}{n})-1}) < \vrfaattemptsbound \nonumber\\
	&\implies \frac{(R-1)\thweak}{n_H\thweak(1-\frac{f(1+\delta)}{n}) - 1} < \vrfaattemptsbound 
	\end{align}
	
	Now, let's analyze the relation between $ R $ and $ \vrfaattemptsbound $ to achieve $ \frac{1}{n_H - n_i} < \thweak  $ for all $ n_i $ during an epoch which is equivalent to show that $\frac{1}{n_H - n_i}  \leq  \frac{1}{n_H - \max(n_i)} < \thweak  $. For this, we need to analyze maximum $ n_i $ and consider the worst case the adversary knows all validators who produced with a VRF input-index $ i $ (e.g, it is the case in the last slot).
	
	Probability of one slot is with index $ i $ is $ \frac{1}{\vrfaattemptsbound} $. So, $ \max(E[n_{i}]) = \frac{R}{\vrfaattemptsbound} $ in the worst case. Then, for all $ \delta > 0 $,  
	
	%Now, let's find the probability of $n_{i} \geq  n_H - \frac{1}{\thweak}   $ for all $ L \in [1,R] $ and $ \delta >0 $ such that $ n_H - \frac{1}{\thweak} = \frac{L}{\vrfaattemptsbound} (1+\delta) $ with the  Chernoff bound.
	
	\begin{equation}
	\pr[\max(n_{i}) \geq \frac{R}{\vrfaattemptsbound} (1+\delta)] \leq \exp(-\frac{R\delta^2}{(2+\delta)*\vrfaattemptsbound})  \nonumber
	\end{equation} 
	
	So, it implies that $ \max(n_i) $ cannot be greater than or equal to $ \frac{R}{\vrfaattemptsbound} (1+\delta)] $ with a very high probability. Then, we should satisfy the condition below as well
	
	\begin{equation}\label{cond:neq1}
	n_H -\frac{R}{\vrfaattemptsbound} (1+\delta)]  \geq \frac{1}{\thweak} 
	\end{equation}
	not to prevent the weak corruption.
	
	\item $ c < 1: $  $ \frac{|\vrfwinninglist_V|- \ell_V}{\numanom-(L-1)} <  \thweak$  implies that $ \frac{|\vrfwinninglist_V|- \ell_V}{\thweak} < \numanom-(L-1)  $. Let's analyze the inequality when the left hand side is in the maximum value ($ \ell_V = 0, |\vrfwinninglist_V| = \vrfaattemptsbound$) and the right hand side is in the minimum value ($ L = R $).
	
	$$ \frac{\vrfaattemptsbound}{\thweak} <  \sum_{k \in \mathcal{H}} |\vrfwinninglist_{V_k}| -  \Psi \frac{fc}{n} (1+ \delta)-(R-1)  $$
	
	
	Now let's bound the probability of not having the inequality above i.e.,	$  \sum_{k \in \mathcal{H}} |\vrfwinninglist_{V_k}|   \leq \frac{\vrfaattemptsbound}{\thweak} + \Psi \frac{fc}{n} (1+ \delta) +R-1$. 
	$E[\sum_{k\in\mathcal{H}}\vrfwinninglist_{V_k}] = n_H*c * \vrfaattemptsbound $ so  for all $ \delta_c \in (0,1) $ such that 
	
	\begin{equation}\label{cond:lc1}
	(1-\delta_c) E[\sum_{k \in \mathcal{H}}\vrfwinninglist_{V_k}] \geq \frac{\vrfaattemptsbound}{\thweak} + \Psi \frac{fc}{n} (1+ \delta) +R-1 
	\end{equation}
	
	
	\begin{equation}\label{eq:duringepoch}
	\pr[\sum_{i = 1}^{n_H}|\vrfwinninglist_{V_i}| \leq \frac{\vrfaattemptsbound}{\thweak} + \Psi \frac{fc}{n} (1+ \delta) +R-1] \leq \exp(-\frac{E[\sum_{k \in \mathcal{H}}\vrfwinninglist_{V_k}]\delta^2}{2} ) \nonumber
	\end{equation}
	
	Now, let's analyze the relation between $ R $ and $ \vrfaattemptsbound $ to achieve $ \frac{1}{n_H - n_i} < \thweak$ when $ c < 1 $. The analysis is similar to the case when $ c=0 $ except that $ \max(E[n_{i}]) = \frac{Rc}{\vrfaattemptsbound} $. So, with the same arguments,
	\begin{equation}
	\pr[n_{i,L} \geq    \frac{(Rc}{\vrfaattemptsbound} (1+\delta)] \leq \exp(-\frac{Rc\delta^2}{(2+\delta)*\vrfaattemptsbound})  \nonumber
	\end{equation} 
	Then, we should satisfy the condition below as well
	
	\begin{equation}\label{cond:nl1}
	n_H -\frac{R}{\vrfaattemptsbound} (1+\delta)]  \geq \frac{1}{\thweak} 
	\end{equation}
	not to prevent the weak corruption.
	
\end{itemize}


\paragraph{Influence of $ c $ to the anonymity:} We need the inequalities in condition  (\ref{cond:eq1}) when $ c = 1 $ and (\ref{cond:lc1}) when $ c < 1 $ not to decrease the anonymity levels. For this we check the two conditions (\ref{cond:eq1})  and (\ref{cond:neq1}) when $ c = 1 $ and conditions (\ref{cond:lc1}) and (\ref{cond:nl1}) that show the relation with $ \thweak $. Conditions (\ref{cond:eq1})  and (\ref{cond:neq1}) imply respectively 

$$\thweak > \frac{\vrfaattemptsbound}{n_H \vrfaattemptsbound (1-\alpha)-R +1}$$


$$  \thweak >({n_H -\frac{R}{\vrfaattemptsbound} (1+\delta)})^{-1}$$

where $ \delta \in (0,1) $ and $ \alpha = \frac{f(1+\delta_b)}{n} $. 
So, when $ c = 1 $, we can set  $ \thweak \in \max( \frac{\vrfaattemptsbound}{n_H \vrfaattemptsbound (1-\alpha)-R +1}, ({n_H -\frac{R}{\vrfaattemptsbound} (1+\delta)})^{-1}) $.

and Conditions  (\ref{cond:lc1})  and (\ref{cond:nl1}) imply respectively 

$$\thweak \geq \frac{\vrfaattemptsbound}{n_H  \vrfaattemptsbound (1-\delta-\alpha)-R +1}$$


$$  \thweak > ({n_H -\frac{Rc}{\vrfaattemptsbound} (1+\delta)})^{-1}$$

where $ \delta \in (0,1) $ and $ \alpha = \frac{f(1+\delta_b)}{n} $. 
So, when $ c < 1 $, we can set  $ \thweak \in \max(\frac{\vrfaattemptsbound}{n_H  \vrfaattemptsbound (1-\delta-\alpha)-R +1}, ({n_H -\frac{Rc}{\vrfaattemptsbound} (1+\delta)})^{-1}  $.
This shows us that with the same parameters in both cases, we have smaller lower bound for $ \thweak $ when $c < 1 $. In order to achieve the same threshold, we should increase $ \vrfaattemptsbound $ when $ c < 1 $. Since $ c < 0$ does not increase the anonymity, we should set $ c = 1 $.



Classical VRF security definitions do not capture the notion of unpredictability under malicious key generations. In Sassafras, we need this notion because we do not have any control on how the adversarial keys are generated. David et al. \cite{praos} defined a UC definition for VRF's that capture this notion. We consider this definition in the standard model with the   

\begin{definition}[Ring VRF Security]
	Let (Eval, Prove, Verify) be a ring VRF. We call that a ring VRF is secure if the followings are satisfied:
	
	\begin{itemize}
		\item (Pseudo-randomness) For all $ (\sk, \pk, \mathsf{PK}) $ and for all $ x $, probability that $ \Out(sk, pk, .)\rightarrow \omega $ is $ \frac{1}{2^{\ell_{VRF}}} + \mathsf{neg}(\ell_{VRF}) $.
		\item (Anonymity)	
	\end{itemize}
	
\end{definition}

%TODO Does current design give the simulatability
%TODO think if we need simulatability for the normal VRF



\begin{theorem}
	The shuffle algorithm is indistinguishable from a random shuffle assuming that ring VRF is simulatable and pseudo random.
\end{theorem}

\begin{proof}
	Without loss of generality, we assume that the first $ m = n - f$ validators $ V_1, V_2,...,V_m $ are honest. 
	
	Imagine an adversary $ \mathcal{A} $ that receives the slot assignments of validators. Assume that $ \mathcal{A} $ distinguishes this assignment from the random assignment with probability $ p_0 $.
	
	Now we reduce the Sassafras slot assignment to another protocol where we replace the VRF outputs with the random numbers and simulate the proof.
	We show that these two assignments are indistinguishable.
	
	We construct an adversary $ \mathcal{B} $ to break the ring VRF's pseudo-randomness property.  VRF game gives $ \pk $.  $ \mathcal{B} $ queries $ r_e||i $ to the VRF game. Then, VRF game gives $ \omega, \pi $. Let's define a hybrid game $ H_{i} $. When we compute the VRF values of first $ i-1 $ validators as described in Sassafras. We compute the VRF outputs of the validators $ V_{i+1},...,V_m $ by replacing the VRF outputs with a random number and simulate the prove.
\end{proof}


\begin{definition}[Chain Growth (CG) Property \cite{backbone}] \label{def:cg}
	The CG  property with parameters $ \tau \in (0,1] $ and $ s_{cg}\in \mathbb{N} $ ensures that if the length of a blockchain owned by an honest party at the onset of a round $ C_u $ is $ \ell_u $ and the length of the same blockchain at round $ C_v  $ where $ C_v \leq C_u - s_{cg}  $ is $\ell_v$, then the $ \ell_u  - \ell_v \geq  \tau s_{cg} $.
\end{definition}

In other words, the CG property guarantees if a chain is owned by an honest party at a round, then this chain has grown $ \tau s_{cg}$ blocks in every $ s_{cg} $ rounds. 

\begin{definition}[Chain Quality (CQ) Property \cite{backbone}]\label{def:cq}
	The CQ property with parameters $ \mu \in (0,1]  $ and $ k \in \mathbb{N} $ ensures that the ratio of honest blocks in any $ k $ length portion of a blockchain owned by an honest party is at least $ \mu $.
\end{definition} 

The CQ property ensures the existence of sufficient honest blocks on  any blockchain owned by an honest party.

We also define a new property which is necessary for our protocol.
\begin{definition}[Chain Density (CD) Property]
	\label{def:cd}
	The CD property with parameters $s_{cd} \in \mathbb{N}$ ensures that  if a blockchain owned by an honest party at the onset of a round $ C_u $ is $ B $ then any portion of  $B$ spanning $s_{cd}$ prior rounds with $n$ blocks  contains  number of $n_h$ honest blocks  where $\frac{n_h}{n}> \frac{1}{2}$.
\end{definition}


We prove the chain growth of the best chain assuming that the weakly corrupted validators do not produce the block. We assume that the adversary can weakly corrupt validators whose chance to produce the next block is less than $ \frac{1}{n} $.


\begin{theorem}
	Sassafras satisfies HCG property with parameters $\tau_{hcg} = p_h(1-\omega)$ where $0 < \omega < 1$ and $s_{hcg} > 0$ in $s_{hcg}$ slots  with probability $1-\exp(-\frac{ p_h s_{hcg} \omega^2}{2})$.
\end{theorem}
\begin{proof}
	We need to count the honest slots (i.e., the slot assigned to at least one honest validator) (Def. Appendix E.5. in \cite{genesis}) to show the HCG property.
	
	We define a game where we let the adversary to win if number of weakly corrupted parties are greater than $ f_w = \Psi\frac{fc}{n}(1+\delta]) $. We know that this can happen with the probability $ \exp(\frac{\Psi f c \delta^2}{n(2+\delta)}) $. Therefore, it is indistinguishable from the first game.
	
	In this game, the total number of corrupted validators are at most $ f + f_w $. Therefore, the probability that an uncorrupted part is a block producer if $ \frac{n - f - f_w}{n} $.
	
	
	The best chain grows one block in honest slots. If honest slots out of $s_{hcg}$ slot are less than $s_{hcg}\tau_{hcg}$, the HCG property is violated. 
	We find below the probability of less than $\tau_{hcg} s_{hcg}$ slots are honest slots. From Chernoff bound we know that
	
	$$\Pr[\sum honest \leq  (1-\omega) p_h s_{hcg}] \leq \exp(-\frac{p_h s_{hcg} \omega^2}{2})$$
	
\end{proof}
